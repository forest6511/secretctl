# Release workflow for secretctl
# Triggered on version tags (v*)
# Uses GoReleaser for CLI + auto-updates Homebrew/Scoop
# Builds Desktop apps separately (requires native compilation)

name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  # ===========================================
  # Test & Security Checks
  # ===========================================
  test:
    name: Test & Security
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24.x'
          cache: true

      - name: Run tests
        run: go test -v -race ./...

      - name: Run linter
        uses: golangci/golangci-lint-action@v6
        with:
          version: latest

      - name: Run security scan
        run: |
          go install github.com/securego/gosec/v2/cmd/gosec@latest
          gosec -severity high -confidence high -exclude-dir=desktop ./...

      - name: Check vulnerabilities
        run: |
          go install golang.org/x/vuln/cmd/govulncheck@latest
          govulncheck ./...

      # Option D+ Compliance Check
      - name: Option D+ Check - No plaintext secret returns
        run: |
          set -euo pipefail
          if grep -rn "secret_get\s*=" internal/mcp/ 2>/dev/null | grep -v "masked\|Masked"; then
            echo "FAIL: Plaintext secret getter found"
            exit 1
          fi
          echo "OK: No plaintext secret getters"

      - name: Option D+ Check - Output sanitization
        run: |
          set -euo pipefail
          if ! grep -rq "Sanitize\|sanitize\|REDACTED" internal/mcp/ 2>/dev/null; then
            echo "FAIL: No output sanitization found"
            exit 1
          fi
          echo "OK: Output sanitization found"

  # ===========================================
  # CLI Release (GoReleaser + Homebrew/Scoop)
  # ===========================================
  cli-release:
    name: CLI Release (GoReleaser)
    needs: test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24.x'
          cache: true

      - name: Run GoReleaser
        uses: goreleaser/goreleaser-action@v6
        with:
          distribution: goreleaser
          version: '~> v2'
          args: release --clean
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          HOMEBREW_TAP_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}

  # ===========================================
  # Desktop Build (Native compilation required)
  # ===========================================
  desktop-build:
    name: Desktop (${{ matrix.os }})
    needs: test
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            platform: linux/amd64
            artifact_name: secretctl-desktop-linux-amd64
            wails_tags: webkit2_41
            deps_cmd: |
              sudo apt-get update
              sudo apt-get install -y libgtk-3-dev libwebkit2gtk-4.1-dev
          - os: macos-latest
            platform: darwin/universal
            artifact_name: secretctl-desktop-macos-universal
            wails_tags: ""
            deps_cmd: ""
          - os: windows-latest
            platform: windows/amd64
            artifact_name: secretctl-desktop-windows-amd64
            wails_tags: ""
            deps_cmd: ""
    runs-on: ${{ matrix.os }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24.x'
          cache: true

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: desktop/frontend/package-lock.json

      - name: Install OS dependencies
        if: matrix.deps_cmd != ''
        run: ${{ matrix.deps_cmd }}
        shell: bash

      - name: Install Wails CLI
        run: go install github.com/wailsapp/wails/v2/cmd/wails@latest

      - name: Install frontend dependencies
        run: |
          cd desktop/frontend
          npm ci

      - name: Build Desktop app
        run: |
          cd desktop
          if [ -n "${{ matrix.wails_tags }}" ]; then
            wails build -platform ${{ matrix.platform }} -tags ${{ matrix.wails_tags }}
          else
            wails build -platform ${{ matrix.platform }}
          fi
        shell: bash

      - name: Package artifact (macOS)
        if: runner.os == 'macOS'
        run: |
          cd desktop/build/bin
          zip -r ${{ matrix.artifact_name }}.zip *.app

      - name: Package artifact (Linux)
        if: runner.os == 'Linux'
        run: |
          cd desktop/build/bin
          tar -czvf ${{ matrix.artifact_name }}.tar.gz secretctl-desktop

      - name: Upload to Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            desktop/build/bin/*.zip
            desktop/build/bin/*.tar.gz
            desktop/build/bin/*.exe
